<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memoir - Digital Photo Book</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:ital,wght@0,100;0,400;0,700;1,400&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap');
        
        body { font-family: 'Sarabun', sans-serif; }
        .font-serif { font-family: 'Playfair Display', serif; }
        
        .paper-shadow {
            box-shadow: 2px 2px 1px rgba(0,0,0,0.05), 0 10px 20px rgba(0,0,0,0.1), 0 6px 6px rgba(0,0,0,0.1);
        }
        .washi-tape {
            background: rgba(251, 191, 36, 0.4);
            backdrop-filter: blur(1px);
            box-shadow: 1px 1px 2px rgba(0,0,0,0.05);
        }
        .perspective-1000 { perspective: 1000px; }
        @media print {
            nav, button, footer, .no-print { display: none !important; }
            body { background-color: white !important; }
            main { padding-top: 0 !important; }
            .page-break { page-break-after: always; }
            .paper-shadow { box-shadow: none !important; border: 1px solid #eee; }
        }
    </style>
</head>
<body class="bg-[#fdfaf6]">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef } = React;
        
        // Firebase modules (Dynamic Import to prevent error if offline)
        let firebaseApp, firestore, authModule;
        
        const getFirebaseConfig = () => {
            try { return (typeof __firebase_config !== 'undefined') ? JSON.parse(__firebase_config) : null; } 
            catch (e) { return null; }
        };

        const config = getFirebaseConfig();
        const isLocalMode = !config;

        const Icon = ({ name, size = 24, className = "" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size }}></i>;
        };

        const App = () => {
            const [user, setUser] = useState(isLocalMode ? { uid: 'local-user' } : null);
            const [books, setBooks] = useState([]);
            const [activeBook, setActiveBook] = useState(null);
            const [loading, setLoading] = useState(true);
            const [showEditor, setShowEditor] = useState(false);
            const [showCreateModal, setShowCreateModal] = useState(false);
            const [isShareView, setIsShareView] = useState(false);
            const [viewOnlyId, setViewOnlyId] = useState(null);
            const [newBookTitle, setNewBookTitle] = useState("");

            // --- DATA ENGINE ---
            const saveBooks = async (updatedBooks) => {
                setBooks(updatedBooks);
                if (isLocalMode) {
                    localStorage.setItem('memoir_books', JSON.stringify(updatedBooks));
                } else {
                    // Firebase logic handled via onSnapshot/Update
                }
            };

            // Initialize Firebase or Local Storage
            useEffect(() => {
                if (isLocalMode) {
                    const saved = localStorage.getItem('memoir_books');
                    if (saved) setBooks(JSON.parse(saved));
                    setLoading(false);
                } else {
                    // Firebase Auth & Firestore Setup
                    const loadFirebase = async () => {
                        const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
                        const { getFirestore, collection, doc, addDoc, onSnapshot, updateDoc, deleteDoc, setDoc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                        const { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");

                        const app = initializeApp(config);
                        const auth = getAuth(app);
                        const db = getFirestore(app);
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'photobook-memoir-v2';

                        // Auth
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }

                        onAuthStateChanged(auth, (u) => {
                            setUser(u);
                            if (u) {
                                const booksRef = collection(db, 'artifacts', appId, 'public', 'data', 'books');
                                onSnapshot(booksRef, (snapshot) => {
                                    const booksData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                    const params = new URLSearchParams(window.location.search);
                                    const sharedId = params.get('book');
                                    
                                    const filtered = booksData.filter(b => b.ownerId === u.uid || b.id === sharedId);
                                    setBooks(filtered);
                                    
                                    if (sharedId) {
                                        const shared = filtered.find(b => b.id === sharedId);
                                        if (shared) {
                                            setActiveBook(shared);
                                            setIsShareView(true);
                                        }
                                    }
                                    setLoading(false);
                                });
                            }
                        });
                    };
                    loadFirebase();
                }
            }, []);

            const createNewBook = async (e) => {
                e.preventDefault();
                if (!newBookTitle.trim()) return;
                
                const newBookData = {
                    id: Date.now().toString(),
                    title: newBookTitle, 
                    createdAt: Date.now(), 
                    ownerId: user?.uid || 'local-user',
                    coverImage: "https://images.unsplash.com/photo-1516627145497-ae6968895b74?q=80&w=1000",
                    pages: [], 
                    likes: 0
                };

                if (isLocalMode) {
                    saveBooks([...books, newBookData]);
                } else {
                    const { getFirestore, collection, addDoc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                    const db = getFirestore();
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'photobook-memoir-v2';
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'books'), newBookData);
                }
                
                setNewBookTitle("");
                setShowCreateModal(false);
            };

            const deleteBook = async (e, bookId) => {
                e.stopPropagation();
                if (!confirm("ลบสมุดเล่มนี้ถาวรใช่ไหม?")) return;
                
                if (isLocalMode) {
                    const filtered = books.filter(b => b.id !== bookId);
                    saveBooks(filtered);
                    if (activeBook?.id === bookId) setActiveBook(null);
                } else {
                    const { getFirestore, doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                    const db = getFirestore();
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'photobook-memoir-v2';
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'books', bookId));
                    if (activeBook?.id === bookId) setActiveBook(null);
                }
            };

            const updateBook = async (updatedBook) => {
                if (isShareView) return;
                
                if (isLocalMode) {
                    const updatedBooks = books.map(b => b.id === updatedBook.id ? updatedBook : b);
                    saveBooks(updatedBooks);
                    setActiveBook(updatedBook);
                } else {
                    const { getFirestore, doc, setDoc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                    const db = getFirestore();
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'photobook-memoir-v2';
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'books', updatedBook.id), updatedBook);
                }
            };

            const shareBook = () => {
                if (isLocalMode) {
                    alert("โหมดใช้งานในเครื่อง (Local Mode) ไม่สามารถแชร์ลิงก์ได้ครับ หากต้องการแชร์ต้องใช้งานผ่านระบบ Cloud");
                    return;
                }
                const url = `${window.location.origin}${window.location.pathname}?book=${activeBook.id}`;
                const dummy = document.createElement("input");
                document.body.appendChild(dummy);
                dummy.value = url; dummy.select();
                document.execCommand("copy");
                document.body.removeChild(dummy);
                alert("คัดลอกลิงก์แชร์แล้ว!");
            };

            if (loading) return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-[#fdfaf6]">
                    <div className="w-16 h-16 border-4 border-stone-200 border-t-stone-800 rounded-full animate-spin"></div>
                    <div className="mt-6 font-serif text-stone-500 tracking-widest uppercase text-sm">กำลังเปิดสมุดบันทึก...</div>
                </div>
            );

            if (!activeBook) return (
                <div className="min-h-screen bg-[#f8f5f0] text-stone-800 p-6 md:p-12">
                    <header className="max-w-6xl mx-auto mb-12 flex flex-col md:flex-row md:justify-between md:items-end gap-6">
                        <div>
                            <div className="flex items-center gap-2 mb-2">
                                <h1 className="text-6xl font-serif font-bold text-stone-900">Memoir.</h1>
                                {isLocalMode && <span className="px-3 py-1 bg-amber-100 text-amber-700 text-[10px] rounded-full font-bold tracking-widest uppercase self-start mt-2">Local Mode</span>}
                            </div>
                            <p className="text-stone-500 font-serif italic text-lg tracking-wide">"เก็บทุกความทรงจำไว้ในหน้ากระดาษดิจิทัล"</p>
                        </div>
                        <button 
                            onClick={() => setShowCreateModal(true)} 
                            className="bg-stone-900 text-white px-8 py-4 rounded-full hover:bg-stone-800 transition-all shadow-xl flex items-center justify-center gap-2 group"
                        >
                            <Icon name="plus" size={20} className="group-hover:rotate-90 transition-transform" /> 
                            <span className="font-bold">เริ่มบันทึกใหม่</span>
                        </button>
                    </header>

                    <main className="max-w-6xl mx-auto grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-10">
                        {books.map(book => (
                            <div key={book.id} onClick={() => setActiveBook(book)} className="group cursor-pointer bg-white p-3 rounded-sm shadow-md hover:shadow-2xl transition-all perspective-1000">
                                <div className="aspect-[3/4] overflow-hidden relative rounded-sm">
                                    <img src={book.pages && book.pages.length > 0 ? book.pages[0].image : book.coverImage} className="w-full h-full object-cover grayscale-[20%] group-hover:grayscale-0 transition-all duration-700" />
                                    <div className="absolute inset-0 bg-black/5" />
                                    <button onClick={(e) => deleteBook(e, book.id)} className="absolute top-4 right-4 p-2 bg-white/90 rounded-full opacity-0 group-hover:opacity-100 hover:bg-red-500 hover:text-white transition-all">
                                        <Icon name="trash-2" size={16} />
                                    </button>
                                </div>
                                <div className="pt-6 pb-4 px-4 text-center">
                                    <h3 className="text-2xl font-serif font-bold text-stone-800 truncate">{book.title}</h3>
                                    <p className="text-stone-400 text-xs uppercase mt-2 tracking-widest">{book.pages?.length || 0} Pages</p>
                                </div>
                            </div>
                        ))}
                        {books.length === 0 && (
                            <div className="col-span-full py-24 text-center border-2 border-dashed border-stone-200 rounded-3xl bg-white/50">
                                <Icon name="book-open" size={48} className="mx-auto text-stone-300 mb-4" />
                                <p className="text-stone-400 font-serif italic text-xl">ยังไม่มีสมุดบันทึกของคุณ เริ่มต้นสร้างเล่มแรกได้เลย</p>
                            </div>
                        )}
                    </main>

                    {showCreateModal && (
                        <div className="fixed inset-0 z-[200] flex items-center justify-center p-4">
                            <div className="absolute inset-0 bg-stone-900/60 backdrop-blur-md" onClick={() => setShowCreateModal(false)} />
                            <form onSubmit={createNewBook} className="relative bg-white w-full max-w-md rounded-[2.5rem] p-10 shadow-2xl space-y-8 animate-in zoom-in-95 duration-300">
                                <div className="text-center">
                                    <h3 className="text-3xl font-serif font-bold text-stone-900">สร้างสมุดเล่มใหม่</h3>
                                    <p className="text-stone-400 text-sm mt-2">ตั้งชื่อให้กับความทรงจำชุดนี้ของคุณ</p>
                                </div>
                                <input 
                                    autoFocus
                                    value={newBookTitle}
                                    onChange={(e) => setNewBookTitle(e.target.value)}
                                    placeholder="เช่น ทริปญี่ปุ่น 2024..." 
                                    className="w-full p-5 rounded-2xl bg-stone-50 border border-stone-100 outline-none focus:ring-4 focus:ring-amber-100 transition-all text-lg"
                                    required
                                />
                                <div className="flex gap-3">
                                    <button type="button" onClick={() => setShowCreateModal(false)} className="flex-1 py-4 bg-stone-100 text-stone-600 rounded-2xl font-bold hover:bg-stone-200 transition-all">ยกเลิก</button>
                                    <button type="submit" className="flex-[2] py-4 bg-stone-900 text-white rounded-2xl font-bold hover:bg-stone-800 shadow-lg transition-all">ตกลง</button>
                                </div>
                            </form>
                        </div>
                    )}
                </div>
            );

            return (
                <div className="min-h-screen bg-[#fdfaf6]">
                    <nav className="fixed top-0 inset-x-0 z-[100] bg-white/70 backdrop-blur-xl border-b border-stone-100 px-6 py-4 no-print flex justify-between items-center">
                        <div className="flex items-center gap-4">
                            <button onClick={() => {setActiveBook(null); setIsShareView(false); window.history.replaceState({}, '', window.location.pathname);}} className="p-2 hover:bg-stone-100 rounded-full transition-colors text-stone-600">
                                <Icon name="arrow-left" />
                            </button>
                            <h2 className="text-2xl font-serif font-bold text-stone-900">{activeBook.title}</h2>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => window.print()} className="p-3 border border-stone-200 rounded-full hover:bg-stone-50 text-stone-600" title="พิมพ์/PDF"><Icon name="printer" size={20} /></button>
                            {!isShareView && <button onClick={shareBook} className="p-3 border border-stone-200 rounded-full hover:bg-stone-50 text-stone-600"><Icon name="share-2" size={20} /></button>}
                            {!isShareView && (
                                <button onClick={() => setShowEditor(true)} className="bg-stone-900 text-white px-6 py-2 rounded-full flex items-center gap-2 hover:bg-stone-800 shadow-lg transition-all">
                                    <Icon name="plus" size={18} /> <span className="font-bold">เพิ่มรูป</span>
                                </button>
                            )}
                        </div>
                    </nav>

                    <main className="max-w-2xl mx-auto pt-32 pb-40 px-6 space-y-24">
                        {activeBook.pages?.map((page, index) => (
                            <div key={index} className="relative group page-break animate-in fade-in slide-in-from-bottom-10 duration-700">
                                <div className="absolute -top-3 left-1/2 -translate-x-1/2 w-24 h-8 washi-tape -rotate-2 z-20 opacity-80" />
                                <div className="bg-white p-6 pb-12 paper-shadow rounded-sm transform rotate-1 group-even:-rotate-1 relative">
                                    <div className="aspect-[4/5] bg-stone-50 overflow-hidden mb-8 border-8 border-stone-50 shadow-inner rounded-sm">
                                        <img src={page.image} className="w-full h-full object-cover" />
                                    </div>
                                    {page.text && <p className="font-serif text-2xl text-stone-700 text-center italic leading-relaxed">"{page.text}"</p>}
                                </div>
                                {!isShareView && (
                                    <button onClick={() => {const np = [...activeBook.pages]; np.splice(index, 1); updateBook({...activeBook, pages: np});}} className="absolute -top-4 -right-4 p-3 bg-white text-red-500 rounded-full shadow-lg opacity-0 group-hover:opacity-100 no-print hover:bg-red-50 transition-all">
                                        <Icon name="trash-2" size={18} />
                                    </button>
                                )}
                            </div>
                        ))}
                    </main>

                    {showEditor && (
                        <div className="fixed inset-0 z-[200] flex items-center justify-center p-4">
                            <div className="absolute inset-0 bg-stone-900/60 backdrop-blur-md" onClick={() => setShowEditor(false)} />
                            <form onSubmit={async (e) => {
                                e.preventDefault();
                                const fd = new FormData(e.target);
                                const np = [...(activeBook.pages || []), { image: fd.get('imageUrl'), text: fd.get('text') }];
                                await updateBook({...activeBook, pages: np});
                                setShowEditor(false);
                            }} className="relative bg-white w-full max-w-lg rounded-[2.5rem] p-8 shadow-2xl space-y-6 animate-in zoom-in-95 duration-300">
                                <div className="flex justify-between items-center">
                                    <h3 className="text-3xl font-serif font-bold text-stone-900">บันทึกหน้าใหม่</h3>
                                    <button type="button" onClick={() => setShowEditor(false)} className="text-stone-400 hover:text-stone-600"><Icon name="x" size={24} /></button>
                                </div>
                                <input name="imageUrl" type="url" placeholder="Link รูปภาพ (URL)" required className="w-full p-4 rounded-2xl bg-stone-50 border outline-none focus:ring-4 focus:ring-amber-100 transition-all" />
                                <textarea name="text" placeholder="บรรยายความรู้สึก..." rows="3" className="w-full p-4 rounded-2xl bg-stone-50 border outline-none focus:ring-4 focus:ring-amber-100 resize-none transition-all" />
                                <button type="submit" className="w-full py-5 bg-stone-900 text-white rounded-2xl font-bold text-lg hover:bg-stone-800 shadow-lg transition-all">บันทึกความทรงจำ</button>
                            </form>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
