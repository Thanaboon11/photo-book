<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Legacy | Memory Optimized</title>
    <link href="https://fonts.googleapis.com/css2?family=Mali:wght@400;700&family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root { --paper: #fdfaf6; --sage: #7d8471; --gold: #b88d5c; --line: #bbb; }
        body { font-family: 'Sarabun', sans-serif; background-color: #efede8; margin: 0; padding-bottom: 100px; }
        
        nav { background: var(--sage); padding: 10px 20px; display: flex; justify-content: space-between; position: sticky; top: 0; z-index: 1000; color: white; }
        .storage-bar { font-size: 0.7rem; background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 10px; margin-left: 10px; }
        .nav-btn { background: none; border: 1px solid #fff; color: white; padding: 5px 12px; border-radius: 15px; cursor: pointer; font-family: 'Mali'; font-size: 0.8rem; }
        .nav-btn.active { background: white; color: var(--sage); }

        header { text-align: center; padding: 20px; background: var(--paper); border-bottom: 1px solid #ddd; }
        h1 { font-family: 'Mali'; font-size: 1.8rem; color: var(--sage); margin: 0; }

        /* Tree Styles */
        #treeView { padding: 40px 0; overflow-x: auto; text-align: center; }
        .tree ul { display: flex; justify-content: center; position: relative; padding-top: 20px; }
        .tree li { list-style: none; position: relative; padding: 20px 5px 0 5px; }
        .tree li::before, .tree li::after { content: ''; position: absolute; top: 0; right: 50%; border-top: 2px solid var(--line); width: 50%; height: 20px; }
        .tree li::after { right: auto; left: 50%; border-left: 2px solid var(--line); }
        .tree li:only-child::after, .tree li:only-child::before { display: none; }
        .tree li:only-child { padding-top: 0; }
        .tree li:first-child::after { border-radius: 5px 0 0 0; }
        .tree li:last-child::before { border-right: 2px solid var(--line); border-radius: 0 5px 0 0; }
        .tree ul ul::before { content: ''; position: absolute; top: 0; left: 50%; border-left: 2px solid var(--line); width: 0; height: 20px; }

        .node { 
            background: white; border: 2px solid var(--sage); padding: 8px; border-radius: 10px; 
            display: inline-block; min-width: 100px; cursor: grab; position: relative;
        }
        .node img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; display: block; margin: 0 auto 5px; }
        .node b { font-family: 'Mali'; font-size: 0.75rem; display: block; }
        .node.drag-over { border-color: var(--gold); background: #fffcf0; transform: scale(1.1); }

        .btn-add { position: fixed; bottom: 20px; right: 20px; width: 55px; height: 55px; border-radius: 50%; background: var(--gold); color: white; border: none; font-size: 24px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 2000; }

        /* Modal */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); z-index: 3000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 15px; width: 300px; }
        input { width: 100%; padding: 8px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .save-btn { width: 100%; background: var(--sage); color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-family: 'Mali'; }
        
        .drop-zone { border: 2px dashed var(--gold); padding: 10px; border-radius: 10px; margin: 10px auto; max-width: 300px; color: var(--gold); font-size: 0.8rem; text-align: center; font-family: 'Mali'; }
    </style>
</head>
<body>

<nav>
    <div>
        <button class="nav-btn active" onclick="switchView('tree')">üå≥ ‡∏ú‡∏±‡∏á‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß</button>
        <button class="nav-btn" onclick="exportData()">üíæ ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
    <div class="storage-bar" id="storageInfo">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...</div>
</nav>

<header>
    <h1>Family Tree</h1>
    <div class="drop-zone" ondragover="e=>e.preventDefault()" ondrop="dropToRoot(event)">
        üñ±Ô∏è ‡∏•‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
    </div>
</header>

<div id="treeView" style="display: block;">
    <div class="tree" id="treeContent"></div>
</div>

<button class="btn-add" onclick="openModal()">+</button>

<div id="memberModal" class="modal">
    <div class="modal-content">
        <h3 style="font-family: 'Mali'; text-align: center; margin: 0 0 15px 0;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</h3>
        <input type="file" id="mImg" accept="image/*">
        <input type="text" id="mName" placeholder="‡∏ä‡∏∑‡πà‡∏≠">
        <input type="text" id="mRel" placeholder="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå (‡∏û‡πà‡∏≠, ‡πÅ‡∏°‡πà...)">
        <button class="save-btn" onclick="saveMember()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button onclick="closeModal()" style="width:100%; background:none; border:none; margin-top:10px; color:#aaa; cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
</div>

<script>
    let family = JSON.parse(localStorage.getItem('family_v8_slim')) || [];
    let draggedId = null;

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    function updateStorageInfo() {
        const used = encodeURIComponent(JSON.stringify(family)).length;
        const limit = 5 * 1024 * 1024; // 5MB ‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì
        const percent = ((used / limit) * 100).toFixed(1);
        document.getElementById('storageInfo').innerText = `‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏õ: ${percent}% (‡∏´‡∏≤‡∏Å‡πÄ‡∏ï‡πá‡∏°‡πÉ‡∏´‡πâ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)`;
    }

    function switchView(v) { /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏á‡πà‡∏≤‡∏¢ ‡πÄ‡∏ô‡πâ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß */ renderTree(); }

    function openModal() { document.getElementById('memberModal').style.display = 'flex'; }
    function closeModal() { document.getElementById('memberModal').style.display = 'none'; }

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡πà‡∏≠‡∏£‡∏π‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡πÄ‡∏ó‡∏û (‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏Å‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏°‡∏°‡πÄ‡∏ï‡πá‡∏°) ---
    async function compressImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const size = 150; // ‡∏¢‡πà‡∏≠‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà 150px ‡∏û‡∏≠ (‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÄ‡∏°‡∏°‡∏°‡∏´‡∏≤‡∏®‡∏≤‡∏•)
                    canvas.width = size;
                    canvas.height = size;
                    const ctx = canvas.getContext('2d');
                    // ‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏ß‡∏á‡∏Å‡∏•‡∏°
                    ctx.drawImage(img, 0, 0, size, size);
                    // ‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô JPEG ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û 0.5 (‡πÄ‡∏•‡πá‡∏Å‡∏°‡∏≤‡∏Å‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏î‡∏π‡∏≠‡∏≠‡∏Å)
                    resolve(canvas.toDataURL('image/jpeg', 0.5));
                };
            };
        });
    }

    async function saveMember() {
        const name = document.getElementById('mName').value;
        const rel = document.getElementById('mRel').value;
        const file = document.getElementById('mImg').files[0];

        if (!name) return alert("‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠");

        let imgData = "https://www.w3schools.com/howto/img_avatar.png";
        if (file) imgData = await compressImage(file);

        family.push({ id: "P" + Date.now(), name, relation: rel, img: imgData, parentId: "" });
        saveAndSync();
        closeModal();
    }

    function saveAndSync() {
        try {
            localStorage.setItem('family_v8_slim', JSON.stringify(family));
            updateStorageInfo();
            renderTree();
        } catch (e) {
            alert("‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏ï‡πá‡∏°! ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà");
        }
    }

    // --- DRAG & DROP ---
    function renderTree() {
        document.getElementById('treeContent').innerHTML = buildTreeHTML("");
    }

    function buildTreeHTML(pId = "") {
        const children = family.filter(m => m.parentId === pId);
        if (children.length === 0) return "";
        let html = "<ul>";
        children.forEach(m => {
            html += `
                <li>
                    <div class="node" draggable="true" 
                         ondragstart="draggedId='${m.id}'"
                         ondragover="e=>{e.preventDefault(); e.currentTarget.classList.add('drag-over')}"
                         ondragleave="e=>e.currentTarget.classList.remove('drag-over')"
                         ondrop="dropOnMember(event, '${m.id}')">
                        <img src="${m.img}">
                        <b>${m.name}</b>
                        <button onclick="deleteMember('${m.id}')" style="position:absolute; top:-5px; right:-5px; background:red; color:white; border-radius:50%; border:none; width:18px; height:18px; font-size:10px; cursor:pointer;">X</button>
                    </div>
                    ${buildTreeHTML(m.id)}
                </li>`;
        });
        html += "</ul>";
        return html;
    }

    function dropOnMember(e, targetId) {
        e.preventDefault();
        e.currentTarget.classList.remove('drag-over');
        if (draggedId === targetId) return;
        const person = family.find(m => m.id === draggedId);
        if (person) { person.parentId = targetId; saveAndSync(); }
    }

    function dropToRoot(e) {
        e.preventDefault();
        const person = family.find(m => m.id === draggedId);
        if (person) { person.parentId = ""; saveAndSync(); }
    }

    function deleteMember(id) {
        if(confirm("‡∏•‡∏ö‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?")) {
            family = family.filter(m => m.id !== id);
            saveAndSync();
        }
    }

    function exportData() {
        const blob = new Blob([JSON.stringify(family)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'family_memory_backup.json';
        a.click();
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    updateStorageInfo();
    renderTree();
</script>
</body>
</html>
